<!doctype html>
<html lang="en" class="h-full">
<head>
  <script>
(function() {
  function redirectBlocked() {
    window.location.href = '/blocked';
  }

  function initDevToolsProtection() {
    console.log('üõ°Ô∏è DevTools protection active');

    // ŸÖŸÜÿπ ŸÉŸÑŸäŸÉ ŸäŸÖŸäŸÜ
    document.addEventListener('contextmenu', e => e.preventDefault());

    // ŸÖŸÜÿπ ŸÖŸÅÿßÿ™Ÿäÿ≠ ŸÖÿπŸäŸÜÿ©
    document.addEventListener('keydown', e => {
      if (
        e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && (e.key.toUpperCase() === 'I' || e.key.toUpperCase() === 'J')) ||
        (e.ctrlKey && e.key.toUpperCase() === 'U')
      ) {
        e.preventDefault();
        e.stopPropagation();
        redirectBlocked();
        return false;
      }
    });

    // ŸÉÿ¥ŸÅ DevTools ÿ®ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ≠ÿ¨ŸÖ
    setInterval(() => {
      const widthDiff = window.outerWidth - window.innerWidth;
      const heightDiff = window.outerHeight - window.innerHeight;
      if (widthDiff > 160 || heightDiff > 160) {
        redirectBlocked();
      }
    }, 500);

    // ŸÉÿ¥ŸÅ DevTools ÿ®ÿ∑ÿ±ŸäŸÇÿ© console
    const check = () => {
      const start = performance.now();
      debugger; // ‚Üê ŸÑŸà ÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖŸÅÿ™Ÿàÿ≠ÿ© Ÿáÿ™ÿ™ÿ£ÿÆÿ± ŸáŸÜÿß
      if (performance.now() - start > 50) {
        redirectBlocked();
      }
    };
    setInterval(check, 1000);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDevToolsProtection);
  } else {
    initDevToolsProtection();
  }
})();
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Program</title>
  <script src="/static/tailwind.cdn.js"></script>

  <meta name="color-scheme" content="light dark">
  <style>
    .card{border-radius:1rem;background:var(--tw-bg,#fff);box-shadow:0 8px 24px rgba(0,0,0,.08);padding:1rem}
    .btn{padding:.6rem .9rem;border-radius:.8rem;border:1px solid rgba(148,163,184,.4);background:transparent}
    .btn:hover{background:rgba(148,163,184,.08)}
    .picker-btn{display:flex;align-items:center;justify-content:space-between;width:100%}
    .chip{font-size:.8rem;padding:.2rem .45rem;border-radius:.6rem;border:1px solid rgba(148,163,184,.45)}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-end;justify-content:center;z-index:60}
    .modal{width:100%;max-width:700px;background:var(--tw-bg,#fff);border-top-left-radius:1rem;border-top-right-radius:1rem;padding:1rem 1rem 1.25rem 1rem;
           box-shadow:0 -10px 30px rgba(0,0,0,.2)}
    .opt{display:flex;align-items:center;justify-content:space-between;padding:.6rem .75rem;border-radius:.6rem;border:1px solid transparent}
    .opt:hover{background:rgba(148,163,184,.12);border-color:rgba(148,163,184,.35)}
    [contenteditable="true"] {border-bottom: 1px dashed rgba(148,163,184,.6); cursor:text;}
    [contenteditable="true"]:focus {outline:none; border-color:#16a34a;}
   .add-box {
    background-color: #f3f4f6; /* ÿ±ŸÖÿßÿØŸä ŸÅÿßÿ™ÿ≠ */
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .add-box:hover {
    background-color: #e5e7eb; /* ÿ£ÿ∫ŸÖŸÇ ÿ¥ŸàŸäÿ© ÿπŸÜÿØ hover */
  }

  .plus-circle {
    background-color: #16a34a; /* ŸÜŸÅÿ≥ ÿØÿ±ÿ¨ÿ© bg-green-600 */
    color: white;
    font-family: 'Baloo 2', cursive;
    font-size: 22px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: grid;
    place-items: center; /* ÿ™Ÿàÿ≥Ÿäÿ∑ ÿØŸÇŸäŸÇ ÿ£ŸÅŸÇŸäŸãÿß ŸàÿπŸÖŸàÿØŸäŸãÿß */
    line-height: 1;
    font-weight: 600;
    transform: translateY(-1px); /* ÿ™ÿµÿ≠Ÿäÿ≠ ÿ®ÿµÿ±Ÿä ÿ®ÿ≥Ÿäÿ∑ */
    transition: background-color 0.2s ease, transform 0.15s ease;
  }

  .add-box:hover .plus-circle {
    background-color: #15803d; /* hover:bg-green-700 */
    transform: scale(1.07);
  }
    @media (prefers-color-scheme: dark){:root{--tw-bg:#0e1628;color-scheme:dark}body{color:#e5e7eb;background:#0b1220}.card{background:#0e1628}}

  </style>
</head>

<body class="min-h-full">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <!-- HEADER -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="{{ url_for('home.page_index') }}" class="px-3 py-2 rounded-lg border">‚Üê Back</a>
        <h1 class="text-xl font-semibold">Create Program CSV</h1>
      </div>
      <img src="/static/meeserve.png" alt="Meeserv Logo" class="h-10">
    </header>

    <!-- MAIN SECTION -->
    <div class="flex items-start gap-8 mt-4">
      
      <!-- LEFT SIDEBAR -->
      <aside class="w-64 shrink-0">
        <nav class="bg-white dark:bg-[#0e1628] border border-gray-200/70 dark:border-slate-700 rounded-xl p-3 space-y-1">
          <a href="{{ url_for('home.page_index') }}" class="group flex items-center justify-between w-full px-3 py-2 rounded-lg border border-transparent hover:border-slate-300/70 hover:bg-slate-50/40 dark:hover:bg-slate-800/40 transition">
            <span class="flex items-center gap-2"><span aria-hidden="true"></span><span class="font-medium">Home</span></span>
            <span class="opacity-50 group-hover:opacity-80">‚Ä∫</span>
          </a>

          <a href="{{ url_for('SQL.sql_connection') }}" class="group flex items-center justify-between w-full px-3 py-2 rounded-lg border border-transparent hover:border-slate-300/70 hover:bg-slate-50/40 dark:hover:bg-slate-800/40 transition">
            <span class="flex items-center gap-2"><span aria-hidden="true"></span><span class="font-medium">SQL Connection</span></span>
            <span class="opacity-50 group-hover:opacity-80">‚Ä∫</span>
          </a>

          <button id="btnAdjustTimes" class="group flex items-center justify-between w-full px-3 py-2 rounded-lg border border-transparent hover:border-slate-300/70 hover:bg-slate-50/40 dark:hover:bg-slate-800/40 transition text-left">
            <span class="flex items-center gap-2"><span aria-hidden="true"></span><span class="font-medium">Adjust Times</span></span>
            <span class="opacity-50 group-hover:opacity-80">‚Ä∫</span>
          </button>

          <a href="{{ url_for('CreateUser.create_user') }}" class="group flex items-center justify-between w-full px-3 py-2 rounded-lg border border-transparent hover:border-slate-300/70 hover:bg-slate-50/40 dark:hover:bg-slate-800/40 transition">
            <span class="flex items-center gap-2"><span aria-hidden="true"></span><span class="font-medium">Create New User</span></span>
            <span class="opacity-50 group-hover:opacity-80">‚Ä∫</span>
          </a>

          <div class="pt-2 mt-2 border-t border-slate-200/70 dark:border-slate-700">
            <a href="{{ url_for('auth.login') }}" class="block px-3 py-2 rounded-lg hover:bg-slate-50/40 dark:hover:bg-slate-800/40 font-semibold text-[#0382b8]">Logout</a>
          </div>
        </nav>
      </aside>

      <!-- RIGHT FORM SECTION -->
      <main class="flex-1">
     <form method="POST" class="card space-y-5" onsubmit="return validateForm()">
      <div>
        <label class="block text-sm opacity-80 mb-1">Model Name <span class="text-red-500">*</span></label>
        <input type="text" name="ModelName" id="ModelName" required class="w-full rounded-lg border p-3 bg-transparent" placeholder="beko" value="{{ ModelName if ModelName else '' }}" />
      </div>
      <div>
        <label class="block text-sm opacity-80 mb-1">SKU <span class="text-red-500">*</span></label>
        <input type="text" name="sku" id="sku" required class="w-full rounded-lg border p-3 bg-transparent" placeholder="WMT-1234" value="{{ sku if sku else '' }}" />
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

        <!-- Station fields -->
        <div>
          <button type="button" class="btn picker-btn" onclick="openPicker('front_logo')">
            <span contenteditable="true" class="editable-label" data-key="front_logo">Front Logo</span><span class="text-red-500">*</span>
            <span id="disp_front_logo" class="chip">Select‚Ä¶</span>
          </button>
          <input type="hidden" name="front_logo" id="front_logo" value="{{ front_logo if front_logo else '' }}">
        </div>

        <div>
          <button type="button" class="btn picker-btn" onclick="openPicker('display_logo')">
            <span contenteditable="true" class="editable-label" data-key="display_logo">Display Logo</span><span class="text-red-500">*</span>
            <span id="disp_display_logo" class="chip">Select‚Ä¶</span>
          </button>
          <input type="hidden" name="display_logo" id="display_logo" value="{{ display_logo if display_logo else '' }}">
        </div>

        <div>
          <button type="button" class="btn picker-btn" onclick="openPicker('color')">
            <span contenteditable="true" class="editable-label" data-key="color">Color</span><span class="text-red-500">*</span>
            <span id="disp_color" class="chip">Select‚Ä¶</span>
          </button>
          <input type="hidden" name="color" id="color" value="{{ color if color else '' }}">
        </div>

        <div>
          <button type="button" class="btn picker-btn" onclick="openPicker('data_logo')">
            <span contenteditable="true" class="editable-label" data-key="data_logo">Data logo</span><span class="text-red-500">*</span>
            <span id="disp_data_logo" class="chip">Select‚Ä¶</span>
          </button>
          <input type="hidden" name="data_logo" id="data_logo" value="{{ data_logo if data_logo else '' }}">
        </div>

        <div>
          <button type="button" class="btn picker-btn" onclick="openPicker('inverter_logo')">
            <span contenteditable="true" class="editable-label" data-key="inverter_logo">Inverter logo</span><span class="text-red-500">*</span>
            <span id="disp_inverter_logo" class="chip">Select‚Ä¶</span>
          </button>
          <input type="hidden" name="inverter_logo" id="inverter_logo" value="{{ inverter_logo if inverter_logo else '' }}">
        </div>

        <div>
          <button type="button" class="btn picker-btn" onclick="openPicker('power_logo')">
            <span contenteditable="true" class="editable-label" data-key="power_logo">Power logo</span><span class="text-red-500">*</span>
            <span id="disp_power_logo" class="chip">Select‚Ä¶</span>
          </button>
          <input type="hidden" name="power_logo" id="power_logo" value="{{ power_logo if power_logo else '' }}">
        </div>

        <div>
          <button type="button" class="btn picker-btn" onclick="openPicker('eva_cover')">
            <span contenteditable="true" class="editable-label" data-key="eva_cover">Eva cover</span><span class="text-red-500">*</span>
            <span id="disp_eva_cover" class="chip">Select‚Ä¶</span>
          </button>
          <input type="hidden" name="eva_cover" id="eva_cover" value="{{ eva_cover if eva_cover else '' }}">
        </div>

        <div>
          <button type="button" class="btn picker-btn" onclick="openPicker('drawer_printing')">
            <span contenteditable="true" class="editable-label" data-key="drawer_printing">Drawer printing</span><span class="text-red-500">*</span>
            <span id="disp_drawer_printing" class="chip">Select‚Ä¶</span>
          </button>
          <input type="hidden" name="drawer_printing" id="drawer_printing" value="{{ drawer_printing if drawer_printing else '' }}">
        </div>

        <div>
          <button type="button" class="btn picker-btn" onclick="openPicker('color_logo')">
            <span contenteditable="true" class="editable-label" data-key="color_logo">Color logo</span><span class="text-red-500">*</span>
            <span id="disp_color_logo" class="chip">Select‚Ä¶</span>
          </button>
          <input type="hidden" name="color_logo" id="color_logo" value="{{ color_logo if color_logo else '' }}">
        </div>

        <div>
          <button type="button" class="btn picker-btn" onclick="openPicker('fan_cover')">
            <span contenteditable="true" class="editable-label" data-key="fan_cover">Fan cover</span><span class="text-red-500">*</span>
            <span id="disp_fan_cover" class="chip">Select‚Ä¶</span>
          </button>
          <input type="hidden" name="fan_cover" id="fan_cover" value="{{ fan_cover if fan_cover else '' }}">
        </div>

        <div>
          <button type="button" class="btn picker-btn" onclick="openPicker('shelve_color')">
            <span contenteditable="true" class="editable-label" data-key="shelve_color">Shelve color</span><span class="text-red-500">*</span>
            <span id="disp_shelve_color" class="chip">Select‚Ä¶</span>
          </button>
          <input type="hidden" name="shelve_color" id="shelve_color" value="{{ shelve_color if shelve_color else '' }}">
        </div>

        {% for t in tests %}
        <div class="flex items-center gap-2 w-full">
          <button type="button" class="btn picker-btn flex-1" data-test="{{ t.name|replace(' ', '_') }}">
            <span>{{ t.name }}</span>
            <span id="selected-{{ t.name|replace(' ', '_') }}" class="chip">Select...</span>
          </button>
          <input type="hidden" name="{{ t.name|replace(' ', '_') }}" id="{{ t.name|replace(' ', '_') }}">
          <button type="button" class="bg-gray-200 hover:bg-gray-300 text-red-600 px-3 py-2 rounded-md" onclick="deleteTest('{{ t.name }}')">üóë</button>
        </div>
        {% endfor %}
     

        <!--ADD NEW TEST BUTTON-->
  <div class="add-box">
    <a href="{{ url_for('CreateProgram.page_create_program') }}">
      <div class="plus-circle">+</div>
    </a>
  </div>
 </div>
     <!-- Buttons row inside form -->
<div class="pt-2 flex items-center w-full gap-4">
  <button type="submit"
    class="flex-[3] py-3 rounded-xl bg-green-600 text-white hover:bg-green-700 text-base font-semibold">
    Create Program
  </button>

  <button type="button"
    class="flex-[1] py-3 rounded-lg bg-red-600 text-white hover:bg-red-700 text-base font-medium"
    onclick="resetDefaults()">
    Reset
  </button>
</div>

    </form>
    {% if submitted %}
      <div class="card">
        <div class="text-green-500 font-semibold">Program created</div>
        <div class="text-sm mt-2">
          SKU: <span class="font-mono">{{ sku }}</span><br/>
          Model Name: <span class="font-mono">{{ ModelName }}</span><br/>
        </div>
        {% if save_success_s1 or save_success_s2 %}
          <div class="mt-3 p-3 border rounded-lg space-y-3">
            {% if save_success_s1 %}
              <div class="font-medium">{{ save_success_s1 }}</div>
              <a class="text-blue-500 underline" href="{{ url_for('CreateProgram.download_program', filename=filename_s1) }}">Download {{ filename_s1 }}</a>
            {% endif %}
            {% if save_success_s2 %}
              <div class="font-medium">{{ save_success_s2 }}</div>
              <a class="text-blue-500 underline" href="{{ url_for('CreateProgram.download_program', filename=filename_s2) }}">Download {{ filename_s2 }}</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
  </div>



</div>




</div>

    </form>
  </div>


<!-- Modal -->
<div id="modalBackdrop" class="modal-backdrop hidden">
  <div class="modal">
    <div class="flex items-center justify-between mb-2">
      <h3 id="modalTitle" class="text-lg font-semibold">Pick an option</h3>
      <button type="button" class="px-3 py-1 rounded-lg border" onclick="closePicker()">Close</button>
    </div>
    <div id="modalList" class="space-y-2 max-h-[60vh] overflow-auto"></div>
  </div>
</div>

<script>
// ==================== FIXED OPTIONS ====================
let FIXED_OPTIONS = {
front_logo: [["None","00"],["Beko","1A"],["Defy","1B"],["Arcelik","1C"],["Ariston","1D"],["Whirlpool","1E"]],
  display_logo: [["None","00"],["Fish screen","1F"],["Second screen","1G"],["Ahmed screen","1H"],["opt3","1I"],["opt4","1J"]],
  color: [["None","00"],["white","6A"],["Black","6B"],["opt3","6C"],["opt4","6D"],["opt5","6E"]],
  data_logo: [["None","00"],["Beko","4A"],["Defy","4B"],["Arcelik","4C"],["Ariston","4D"],["Whirlpool","4E"]],
  inverter_logo: [["None","00"],["Beko","7A"],["Defy","7B"],["Arcelik","7C"],["Ariston","7D"],["Whirlpool","7E"]],
  power_logo: [["None","00"],["Beko","3A"],["Defy","3B"],["Arcelik","3C"],["Ariston","3D"],["Whirlpool","3E"]],
  eva_cover: [["None","00"],["Beko","2A"],["Defy","2B"],["Arcelik","2C"],["Ariston","2D"],["Whirlpool","2E"]],
  drawer_printing: [["None","00"],["Veg","5A"],["Dairy","5B"],["Meat","5C"],["opt3","5D"],["opt5","5E"]],
  color_logo: [["None","00"],["white","6A"],["Black","6B"],["opt3","6C"],["opt4","6D"],["opt5","6E"]],
  fan_cover: [["None","00"],["Beko","8A"],["Defy","8B"],["Arcelik","8C"],["Ariston","8D"],["Whirlpool","8E"]],
  shelve_color: [["None","00"],["white","9A"],["Black","9B"],["opt3","9C"],["opt4","9D"],["opt5","9E"]]
};

let FIXED_OPTIONS_ORIGINAL = JSON.parse(JSON.stringify(FIXED_OPTIONS));

/* ================= TESTS from server (Jinja) =================
   Expect `tests` variable passed by Flask: an array of objects
   each { name: "...", station: "S1"/"S2", options: [{name, code}, ...] }
*/
let TESTS = {{ tests|tojson }};

/* Build a map keyed by sanitized name (same convention as HTML ids: spaces -> underscores)
   This makes lookup consistent with the hidden inputs and the button onclick values.
*/
let TESTS_MAP = {};
if (Array.isArray(TESTS)) {
  TESTS.forEach(t => {
    const key = String(t.name).replace(/\s+/g, '_');
    TESTS_MAP[key] = {
      originalName: t.name,
      station: (t.station || '').toUpperCase(),
      options: Array.isArray(t.options) ? t.options.map(o => ({name: o.name, code: o.code})) : []
    };
  });
}

/* ================= Utilities ================= */
function getLabelName(key){
  return localStorage.getItem("label_" + key) || document.querySelector(`[data-key="${key}"]`)?.textContent || key;
}

/* Ensure hidden input exists (matching server-side name/id which is sanitized) */
function ensureHiddenInput(sanitizedKey) {
  let hidden = document.querySelector(`input[name="${sanitizedKey}"]`);
  if (!hidden) {
    hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.name = sanitizedKey;
    hidden.id = sanitizedKey;
    document.querySelector('form')?.appendChild(hidden);
  }
  return hidden;
}

/* ================= Modal (picker) ================= */
let CURRENT_FIELD = null;

function openPicker(fieldKey) {
  // fieldKey is the sanitized key used in HTML (spaces -> underscores)
  CURRENT_FIELD = fieldKey;
  const label = getLabelName(fieldKey);
  document.getElementById('modalTitle').textContent = "Choose " + label;
  const list = document.getElementById('modalList');
  list.innerHTML = "";

  // Edit button (works for both fixed and dynamic)
  const editBtn = document.createElement('button');
  editBtn.textContent = "‚öôÔ∏è Edit options";
  editBtn.className = "btn mb-3";
  editBtn.onclick = () => openOptionsEditor(fieldKey);
  list.appendChild(editBtn);

  // collect options source
  let opts = [];

  // 1) fixed fields (front_logo, color, ...)
  if (FIXED_OPTIONS[fieldKey]) {
    opts = FIXED_OPTIONS[fieldKey].map(o => ({name: o[0], code: o[1]}));
  }
  // 2) dynamic tests (from TESTS_MAP)
  else if (TESTS_MAP[fieldKey]) {
    opts = TESTS_MAP[fieldKey].options.map(o => ({name: o.name, code: o.code}));
  }

  // render options
  if (!opts || opts.length === 0) {
    const msg = document.createElement('p');
    msg.className = "text-sm text-gray-500";
    msg.textContent = "No options available for this item.";
    list.appendChild(msg);
  } else {
    opts.forEach(opt => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'opt w-full text-left border rounded p-2 hover:bg-gray-100';
      btn.innerHTML = `<div class="font-medium">${escapeHtml(opt.name)}</div><div class="text-xs opacity-70">Code: ${escapeHtml(opt.code)}</div>`;
      btn.addEventListener('click', () => chooseOption(fieldKey, opt.name, opt.code));
      list.appendChild(btn);
    });
  }

  document.getElementById('modalBackdrop').style.display = 'flex';
}

function closePicker(){
  document.getElementById('modalBackdrop').style.display = 'none';
  CURRENT_FIELD = null;
}

function chooseOption(fieldKey, name, code) {
  const value = `${name}|${code}`;  // Format: "Label|Code"
  const hidden = ensureHiddenInput(fieldKey);
  if (hidden) hidden.value = value;
  
  const disp = document.getElementById('selected-' + fieldKey) || document.getElementById('disp_' + fieldKey);
  if (disp) disp.textContent = name;
  closePicker();
}

/* ================ Options editor (Edit/Add/Delete/Save/Reset) ================= */
function openOptionsEditor(fieldKey) {
  const list = document.getElementById('modalList');
  list.innerHTML = '';

  const container = document.createElement('div');
  container.innerHTML = `
    <div class="mb-3 flex items-center justify-between">
      <h4 class="font-semibold">Edit options for: ${escapeHtml(getLabelName(fieldKey))}</h4>
      <div class="flex gap-2">
        <button type="button" class="btn" id="addOptionBtn">+ Add</button>
        <button type="button" class="btn" id="cancelEditBtn">Cancel</button>
        <button type="button" class="btn" id="saveEditBtn">Save</button>
      </div>
    </div>
    <div id="optionsEditorList" class="space-y-2 max-h-[50vh] overflow-auto"></div>
  `;
  list.appendChild(container);

  const editorList = container.querySelector('#optionsEditorList');

  // get current options into a mutable array of [label, code]
  let optionsArr = [];
  let isDynamic = false;
  if (FIXED_OPTIONS[fieldKey]) {
    optionsArr = JSON.parse(JSON.stringify(FIXED_OPTIONS[fieldKey]));
  } else if (TESTS_MAP[fieldKey]) {
    isDynamic = true;
    optionsArr = TESTS_MAP[fieldKey].options.map(o => [o.name, o.code]);
  } else {
    optionsArr = [];
  }

  function renderEditorRows() {
    editorList.innerHTML = '';
    optionsArr.forEach(([lbl, cod], idx) => {
      const row = document.createElement('div');
      row.className = 'flex gap-2 items-center';
      row.innerHTML = `
        <input data-idx="${idx}" data-type="label" class="w-1/2 rounded-lg border p-2" value="${escapeHtml(lbl)}"/>
        <input data-idx="${idx}" data-type="code" class="w-1/4 rounded-lg border p-2" value="${escapeHtml(cod)}"/>
        <button data-del="${idx}" class="btn">Delete</button>
      `;
      editorList.appendChild(row);
      row.querySelector(`[data-del="${idx}"]`).addEventListener('click', ()=>{
        optionsArr.splice(idx,1);
        renderEditorRows();
      });
    });
    if (optionsArr.length === 0) {
      const note = document.createElement('p');
      note.className = 'text-sm opacity-70';
      note.textContent = 'No options yet. Add one with + Add';
      editorList.appendChild(note);
    }
  }

  container.querySelector('#addOptionBtn').addEventListener('click', ()=>{
    optionsArr.push(["New option","00"]);
    renderEditorRows();
  });

  container.querySelector('#saveEditBtn').addEventListener('click', ()=>{
    const newList = [];
    Array.from(editorList.children).forEach(row=>{
      const labelInput = row.querySelector('input[data-type="label"]');
      const codeInput = row.querySelector('input[data-type="code"]');
      if (!labelInput || !codeInput) return;
      const lab = labelInput.value.trim() || 'Unnamed';
      const cod = codeInput.value.trim() || '00';
      newList.push([lab, cod]);
    });

    if (isDynamic) {
      // update TESTS_MAP in-memory (so modal and UI reflect change immediately)
      const t = TESTS_MAP[fieldKey];
      if (t) {
        t.options = newList.map(([n,c]) => ({name: n, code: c}));
      }
      // Also update the original TESTS array so future server sync (if any) can pick it up
      for (let i=0;i<TESTS.length;i++){
        if (String(TESTS[i].name).replace(/\s+/g,'_') === fieldKey) {
          TESTS[i].options = newList.map(([n,c]) => ({name: n, code: c}));
          break;
        }
      }
    } else {
      FIXED_OPTIONS[fieldKey] = newList;
    }

    // re-open the picker to show updated list
    openPicker(fieldKey);
  });

  container.querySelector('#cancelEditBtn').addEventListener('click', ()=> openPicker(fieldKey));

  

  renderEditorRows();
}

/* ================= Click handler for picker buttons (uses data-test attribute) ================= */
document.addEventListener("click", function (e) {
  const pickerBtn = e.target.closest(".picker-btn");
  if (!pickerBtn) return;

  const testName = pickerBtn.dataset.test;
  if (!testName) return;

  openPicker(testName);
  e.preventDefault();
});


/* =============== small helper: escapeHtml =============== */
function escapeHtml(str){
  return String(str || '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'", '&#39;');
}
// -------------------- DELETE / RESET --------------------
async function deleteTest(testName) {
  if (!confirm(`Are you sure you want to delete ${testName}?`)) return;
  const res = await fetch('/delete_test', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name: testName})
  });
  alert(res.ok ? '‚úÖ Test deleted successfully' : '‚ùå Something went wrong');
  if (res.ok) location.reload();
}

async function resetDefaults() {
  if (!confirm("‚ö† Are you sure you want to delete all Tests?")) return;
  const res = await fetch('/reset_tests', { method: 'POST' });
  alert(res.ok ? '‚úÖ Tests reset successfully' : '‚ùå Something went wrong');
  if (res.ok) location.reload();
}
// -------------------- VALIDATION --------------------
function validateForm(){
  const sku = document.getElementById('sku').value.trim();
  const requiredIds = ["ModelName","front_logo","display_logo","color","data_logo","inverter_logo","power_logo","eva_cover","drawer_printing","color_logo","fan_cover","shelve_color"];
  if(!sku){ alert('Please enter SKU'); return false; }
  for (const id of requiredIds){
    const v = (document.getElementById(id)?.value || '').trim();
    if(!v){ alert('Please select: ' + getLabelName(id));  return false; }
  }
  document.getElementById('submitBtn').disabled = true;
  document.getElementById('submitBtn').textContent = 'Creating...';
  return true;
}
//--------------------saving----------
function selectOption(testKey, optName, optCode) {
  closePicker();
  
  const chip = document.getElementById(`selected-${testKey}`);
  if (chip) chip.textContent = optName;

  const hidden = document.getElementById(testKey);
  if (hidden) hidden.value = `${optName}|${optCode}`;  // This is the key fix
}

</script>
{% if csv_files %}
    <section class="card">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">Saved Programs</h2>
        <div class="text-xs opacity-75">Newest first</div>
      </div>
      <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2" id="programGrid">
        {% for file in csv_files %}
        <button class="w-full text-left border rounded-lg p-2 hover:bg-slate-50/30" onclick="showProgramData('{{ file.name }}')">
          <div class="font-medium text-sm truncate" title="{{ file.name }}">{{ file.name }}</div>
          <div class="text-[11px] opacity-70">{{ (file.size/1024)|round(1) }} KB</div>
        </button>
        {% endfor %}
      </div>
    </section>
    {% endif %}




<!-- station 1 -->


<div id="manualScannerModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100] hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 w-full max-w-md text-center">
        <h2 class="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è System Alert</h2>
        <p class="text-gray-700 dark:text-gray-300 mb-6">ERROR: Auto SCANNING FAILED in outer station</p>
    
        <div class="flex flex-col gap-4">
            <input id="manualInput" type="text" class="border p-2 rounded w-full" placeholder="Scan or enter code manually">
            <button onclick="submitManualData()" class="bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">
                OK / Confirm
            </button>
        </div>
    </div>
</div>


<script>

setInterval(function() {
    fetch('/check-flags')
        .then(response => response.json())
        .then(data => {
            const modal = document.getElementById('manualScannerModal');
            const modal2 = document.getElementById('noCsv1');
            
            // ŸÑŸà ÿßŸÑŸÅŸÑÿßÿ¨ ÿ£ÿµÿ®ÿ≠ True ŸàÿßŸÑŸÄ Modal ŸÖÿÆŸÅŸäÿå ŸÜÿ∏Ÿáÿ±Ÿá
            if (data.manual_scanner === true) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
            if (data.no_csv_error === true) {
                modal2.classList.remove('hidden');
            } else {
                modal2.classList.add('hidden');
            }
        })
        .catch(err => console.error("Error fetching flags:", err));
}, 1000);

// Ÿàÿ∏ŸäŸÅÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ Ÿàÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ Modal
async function submitManualData() {
    const val = document.getElementById('manualInput').value;
    if (!val) return alert("Please enter data");

    const response = await fetch('/api/station', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ station_data: val })
    });

    if (response.ok) {
        document.getElementById('manualScannerModal').classList.add('hidden');
        document.getElementById('manualInput').value = ""; // ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿ•ÿØÿÆÿßŸÑ
        showToast("Data submitted successfully", "green");
    }
}



</script>


<!-- station 2 -->

<div id="manualScannerModal2" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100] hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 w-full max-w-md text-center">
        <h2 class="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è System Alert</h2>
        <p class="text-gray-700 dark:text-gray-300 mb-6">ERROR: Auto SCANNING FAILED in inner station</p>
    
        <div class="flex flex-col gap-4">
            <input id="manualInput2" type="text" class="border p-2 rounded w-full" placeholder="Scan or enter code manually">
            <button onclick="submitManualData2()" class="bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">
                OK / Confirm
            </button>
        </div>
    </div>
</div>


<script>

setInterval(function() {
    fetch('/check-flags2')
        .then(response => response.json())
        .then(data => {
            const modal = document.getElementById('manualScannerModal2');
            const modal2 = document.getElementById('noCsv2');
            
            
            // ŸÑŸà ÿßŸÑŸÅŸÑÿßÿ¨ ÿ£ÿµÿ®ÿ≠ True ŸàÿßŸÑŸÄ Modal ŸÖÿÆŸÅŸäÿå ŸÜÿ∏Ÿáÿ±Ÿá
            if (data.manual_scanner === true) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }

            if (data.no_csv_error === true) {
                modal2.classList.remove('hidden');
            } 
            else {
                modal2.classList.add('hidden');
            }
            
        })
        .catch(err => console.error("Error fetching flags:", err));
}, 1000);

// Ÿàÿ∏ŸäŸÅÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ Ÿàÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ Modal
async function submitManualData2() {
    const val = document.getElementById('manualInput2').value;
    if (!val) return alert("Please enter data");

    const response = await fetch('/api/station2', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ station_data: val })
    });

    if (response.ok) {
        document.getElementById('manualScannerModal2').classList.add('hidden');
        document.getElementById('manualInput2').value = ""; // ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿ•ÿØÿÆÿßŸÑ
        showToast("Data submitted successfully", "green");
    }
}





</script>

<!-- nocsv station 1 -->

<div id="noCsv1" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100] hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 w-full max-w-md text-center">
        <h2 class="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è System Alert</h2>
        <p class="text-gray-700 dark:text-gray-300 mb-6">ERROR: THERE IS NO CSV IN OUTER STATION</p>
    
        <div class="flex flex-col gap-4">
            <button onclick="document.getElementById('nocsv1').classList.add('hidden')" class="bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">
            OK / Confirm
            </button>
        </div>
    </div>
</div>


<!-- nocsv station 1 -->

<div id="nocsv2" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100] hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 w-full max-w-md text-center">
        <h2 class="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è System Alert</h2>
        <p class="text-gray-700 dark:text-gray-300 mb-6">ERROR: THERE IS NO CSV IN INNER STATION</p>
    
        <div class="flex flex-col gap-4">
            <button onclick="submitCsv2()" class="bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">
            OK / Confirm
            </button>
        </div>
    </div>
</div>



<script>
async function submitCsv2(){
  fetch('/control2',)
        .then(response => response.json())
        .then(data => {
            const modal = document.getElementById('nocsv2');
            
                modal.classList.add('hidden');
      
        })


}



async function submitCsv1(){
  fetch('/control',)
        .then(response => response.json())
        .then(data => {
            const modal = document.getElementById('nocsv1');
            
                modal.classList.add('hidden');
      
        })


}

</script>



</body>
</html>