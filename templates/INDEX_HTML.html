<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<script>
(function() {
  function redirectBlocked() {
    window.location.href = '/blocked';
  }

  function initDevToolsProtection() {
    console.log('ðŸ›¡ï¸ DevTools protection active');

    // Ù…Ù†Ø¹ ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ†
    document.addEventListener('contextmenu', e => e.preventDefault());

    // Ù…Ù†Ø¹ Ù…ÙØ§ØªÙŠØ­ Ù…Ø¹ÙŠÙ†Ø©
    document.addEventListener('keydown', e => {
      if (
        e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && (e.key.toUpperCase() === 'I' || e.key.toUpperCase() === 'J')) ||
        (e.ctrlKey && e.key.toUpperCase() === 'U')
      ) {
        e.preventDefault();
        e.stopPropagation();
        redirectBlocked();
        return false;
      }
    });

    // ÙƒØ´Ù DevTools Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø¬Ù…
    setInterval(() => {
      const widthDiff = window.outerWidth - window.innerWidth;
      const heightDiff = window.outerHeight - window.innerHeight;
      if (widthDiff > 160 || heightDiff > 160) {
        redirectBlocked();
      }
    }, 500);

    // ÙƒØ´Ù DevTools Ø¨Ø·Ø±ÙŠÙ‚Ø© console
    const check = () => {
      const start = performance.now();
      debugger; // â† Ù„Ùˆ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ± Ù…ÙØªÙˆØ­Ø© Ù‡ØªØªØ£Ø®Ø± Ù‡Ù†Ø§
      if (performance.now() - start > 50) {
        redirectBlocked();
      }
    };
    setInterval(check, 1000);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDevToolsProtection);
  } else {
    initDevToolsProtection();
  }
})();
</script>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TCP Console</title>
  <script src="/static/tailwind.cdn.js"></script>
  <meta name="color-scheme" content="light dark">
  <style>
    .card{border-radius:1rem;background:var(--tw-bg,#fff);box-shadow:0 8px 24px rgba(0,0,0,.08);padding:1rem}
    .badge{display:inline-block;font-size:.75rem;padding:.25rem .5rem;border-radius:9999px}
    .badge-ok{background:#dcfce7;color:#166534}.badge-off{background:#e5e7eb;color:#374151}
    .btn{padding:.55rem 1rem;border-radius:.75rem;transition:.15s;box-shadow:0 3px 10px rgba(0,0,0,.06)}
    .btn:hover{transform:translateY(-1px)}.btn-primary{background:#2563eb;color:white}
    .btn-danger{background:#dc2626;color:white}.btn-muted{background:#334155;color:white}
    .btn-ghost{background:transparent;border:1px solid #cbd5e1}.btn[disabled]{opacity:.6;cursor:not-allowed}
    .logbox{height:22rem;overflow:auto;background:rgba(148,163,184,.08);border:1px solid rgba(148,163,184,.35);border-radius:.75rem;padding:.5rem;font-family:ui-monospace,monospace;font-size:.85rem}
    .toast{position:fixed;left:50%;bottom:1.5rem;transform:translateX(-50%);background:white;border-radius:.75rem;padding:.6rem 1rem;box-shadow:0 10px 20px rgba(0,0,0,.15);font-weight:600;z-index:60;border:2px solid transparent;min-width:180px;text-align:center}
    .toast.red{color:#991b1b;border-color:#fecaca;background:#fee2e2}.toast.green{color:#065f46;border-color:#bbf7d0;background:#dcfce7}
    @media (prefers-color-scheme: dark){:root{--tw-bg:#0b1220;color-scheme:dark}body{color:#e5e7eb;background:#0b1220}.card{background:#0e1628}.badge-off{background:#1f2937;color:#e5e7eb}.logbox{background:#0b1220;border-color:#1f334f}.btn-ghost{border-color:#334155;color:#cbd5e1}}
    .switch{position:relative;display:inline-block;width:42px;height:22px}.switch input{display:none}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:2px;bottom:2px;background:#fff;transition:.2s;border-radius:50%}
    input:checked+.slider{background:#10b981}input:checked+.slider:before{transform:translateX(20px)}
  </style>
</head>
<body class="min-h-full">
<div class="max-w-7xl mx-auto p-4 space-y-5">
    <header class="relative flex items-center justify-center">
  
  <!-- center group -->
  <div class="flex items-center gap-3">
    <img src="/static/download.png" alt="Beko Logo" class="h-20">
    <h1 style="font-family: 'Nunito', sans-serif; font-weight: 700;color: #0382b8;  font-size: 1.75rem;" 
    class="text-xl font-semibold">
    Refrigerator Vision System</h1>
  </div>

  <!-- right logo -->
  <div class="absolute right-0 flex items-center gap-3">
    <img src="/static/meeserve.png" alt="Meeserv Logo" class="h-20">
  </div>

</header>

  
 <!-- center group -->
<!-- Layout: sidebar + main content -->
<div class="flex gap-5 items-start mt-8">
  <!-- LEFT SIDEBAR -->
  <aside class="w-64 shrink-0 self-start">
<nav class="bg-white dark:bg-[#0e1628] border border-gray-200/70 dark:border-slate-700 rounded-xl p-6 space-y-4 shadow-md min-h-[650px]">
  
      <a href="{{ url_for('CreateProgram.page_create_program') }}"
        class="group flex items-center justify-between w-full px-3 py-2 rounded-lg border border-transparent hover:border-slate-300/70 hover:bg-slate-50/40 dark:hover:bg-slate-800/40 transition {% if auth != 'admin' %}pointer-events-none opacity-50 cursor-not-allowed{% endif %}">
        <span class="flex items-center gap-2"><span aria-hidden="true"></span><span class="font-medium">Create Program CSV</span></span><span class="opacity-50 group-hover:opacity-80">â€º</span>
      </a>

      <a href="{{ url_for('SQL.sql_connection') }}"
        class="group flex items-center justify-between w-full px-3 py-2 rounded-lg border border-transparent hover:border-slate-300/70 hover:bg-slate-50/40 dark:hover:bg-slate-800/40 transition">
        <span class="flex items-center gap-2"><span aria-hidden="true"></span><span class="font-medium">SQL Connection</span></span><span class="opacity-50 group-hover:opacity-80">â€º</span>
      </a>

      <button id="btnAdjustTimes"
        class="group flex items-center justify-between w-full px-3 py-2 rounded-lg border border-transparent hover:border-slate-300/70 hover:bg-slate-50/40 dark:hover:bg-slate-800/40 transition text-left {% if auth != 'admin' %}pointer-events-none opacity-50 cursor-not-allowed{% endif %}">
        <span class="flex items-center gap-2"><span aria-hidden="true"></span><span class="font-medium">Adjust Times</span></span><span class="opacity-50 group-hover:opacity-80">â€º</span>
      </button>

      <a href="{{ url_for('CreateUser.create_user') }}"
        class="group flex items-center justify-between w-full px-3 py-2 rounded-lg border border-transparent hover:border-slate-300/70 hover:bg-slate-50/40 dark:hover:bg-slate-800/40 transition {% if auth != 'admin' %}pointer-events-none opacity-50 cursor-not-allowed{% endif %}">
        <span class="flex items-center gap-2"><span aria-hidden="true"></span><span class="font-medium">Create New User</span></span><span class="opacity-50 group-hover:opacity-80">â€º</span>
      </a>

      <div class="pt-2 mt-2 border-t border-slate-200/70 dark:border-slate-700">
        <a href="{{ url_for('auth.login') }}"
          class="block px-3 py-2 rounded-lg hover:bg-slate-50/40 dark:hover:bg-slate-800/40 font-semibold text-[#0382b8]">
          Logout
        </a>
      </div>
 
    </nav>
  </aside>

  <!-- RIGHT CONTENT AREA -->
<main class="flex-1 space-y-5">
    <div class="w-11/12 max-w-4xl mx-auto mt-0 space-y-6">

    
    <!-- STATION ONE DUMMY INPUT -->
    <section class="bg-white border border-gray-300 shadow-md rounded-xl p-5 space-y-3">
      <h2 class="font-semibold text-lg">Station One Dummy Number</h2>
      <label class="text-xs opacity-70 block">
        Enter Dummy Number (acts like data from 192.168.1.16:7940)
      </label>
      <div class="flex flex-col md:flex-row gap-3 items-end">
        <input id="dummyStation1" type="text"
          class="w-full md:flex-1 rounded-lg border p-2 bg-transparent font-mono"
          placeholder="R123456789012" maxlength="20" />
        <button id="btnDummyStation1"
          class="w-full md:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg py-2 px-4 transition">
          Send Dummy to Station One
        </button>
      </div>
      <p id="dummyStation1Status" class="text-xs mt-2 text-slate-500"></p>
    </section>

<!-- STATION ONE -->
    <section class="bg-white border border-gray-300 shadow-md rounded-xl p-5 space-y-3">
      <h2 class="font-semibold text-lg">Station One</h2>
      <label class="text-xs opacity-70 block">
        S1 Message (Front Logo, Display logo, Color, Data logo, Inverter logo, Power logo)
      </label>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <div class="md:col-span-2">
          <textarea id="messageS1" rows="3"
            class="w-full mt-1 rounded-lg border p-2 bg-transparent font-mono"
            placeholder="Type text or paste HEX (enable HEX mode)"></textarea>
        </div>
        <div class="space-y-2">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="hexModeS1" type="checkbox"><span>HEX mode</span>
          </label>
          <label class="text-xs opacity-70 block">Per-char delay (ms)</label>
          <input id="delayS1" type="number" value="100"
            class="w-full rounded-lg border p-2 bg-transparent" />
          <button id="btnSendS1"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg py-2 transition">
            Send S1 Data
          </button>
        </div>
      </div>
    </section>

    
    <!-- STATION TWO DUMMY INPUT -->
    <section class="bg-white border border-gray-300 shadow-md rounded-xl p-5 space-y-3">
      <h2 class="font-semibold text-lg">Station Two Dummy Number</h2>
      <label class="text-xs opacity-70 block">
        Enter Dummy Number (acts like data from 192.168.1.17:7950)
      </label>
      <div class="flex flex-col md:flex-row gap-3 items-end">
        <input id="dummyStation2" type="text"
          class="w-full md:flex-1 rounded-lg border p-2 bg-transparent font-mono"
          placeholder="R123456789012" maxlength="20" />
        <button id="btnDummyStation2"
          class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg py-2 px-4 transition">
          Send Dummy to Station Two
        </button>
      </div>
      <p id="dummyStation2Status" class="text-xs mt-2 text-slate-500"></p>
    </section>

<!-- STATION TWO -->
    <section class="bg-white border border-gray-300 shadow-md rounded-xl p-5 space-y-3">
      <h2 class="font-semibold text-lg">Station Two</h2>
      <label class="text-xs opacity-70 block">
        S2 Message (Eva cover, Drawer printing, Color logo, Fan cover, Shelve color)
      </label>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <div class="md:col-span-2">
          <textarea id="messageS2" rows="3"
            class="w-full mt-1 rounded-lg border p-2 bg-transparent font-mono"
            placeholder="Type text or paste HEX (enable HEX mode)"></textarea>
        </div>
        <div class="space-y-2">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="hexModeS2" type="checkbox"><span>HEX mode</span>
          </label>
          <label class="text-xs opacity-70 block">Per-char delay (ms)</label>
          <input id="delayS2" type="number" value="100"
            class="w-full rounded-lg border p-2 bg-transparent" />
          <button id="btnSendS2"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg py-2 transition">
            Send S2 Data
          </button>
        </div>
      </div>
    </section>
    <!-- Legacy single client selection (kept for compatibility) -->
    <section class="card space-y-3" style="display: none;">
      <h2 class="font-semibold">Legacy Send (Single Client)</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="text-xs opacity-70">Message</label>
          <textarea id="message" rows="3" class="w-full mt-1 rounded-lg border p-2 bg-transparent font-mono" placeholder="Type text or paste HEX (enable HEX mode)"></textarea>
        </div>
        <div class="space-y-2">
          <label class="inline-flex items-center gap-2 text-sm"><input id="hexMode" type="checkbox"><span>HEX mode</span></label>
          <label class="text-xs opacity-70">Per-char delay (ms)</label>
          <input id="delay" type="number" value="100" class="w-full rounded-lg border p-2 bg-transparent"/>
          <button id="btnSendAll" class="btn btn-primary w-full">Send (All + Device)</button>
          <div class="flex gap-2">
            <select id="clientSelect" class="w-full rounded-lg border p-2 bg-transparent"></select>
            <button id="btnSendOne" class="btn btn-muted">Send</button>
          </div>
        </div>
      </div>
      <p class="text-[11px] opacity-70">HEX accepts spaced or continuous hex: <span class="font-mono">48 65 6C 6C 6F</span> or <span class="font-mono">48656C6C6F</span>.</p>
    </section>

    <!-- SAVED PROGRAMS -->
    {% if csv_files %}
<section class="card">
  <div class="flex items-center justify-between">
    <h2 class="font-semibold">Saved Programs</h2>
    <div class="text-xs opacity-75">Newest first</div>
  </div>

  <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2" id="programGrid">
    {% for file in csv_files %}
      {% if file.name|lower|trim != 'logins.csv' %}
      <button
        class="w-full text-left border rounded-lg p-2 hover:bg-slate-50/30"
        onclick="showProgramData('{{ file.name }}')">

        <div class="font-medium text-sm truncate" title="{{ file.name }}">{{ file.name }}</div>
        <div class="text-[11px] opacity-70">{{ (file.size/1024)|round(1) }} KB</div>
      </button>
      {% endif %}
    {% endfor %}
  </div>
</section>
{% endif %}

  </div>
</main>

      </div>
    </div>

  </div>

    

   
  </div>
</main>
</div>


</main>
</div>


</main>
</div>
 
</main>
</div>
 
</main>
</div>
<!-- Times Adjustment Modal -->
  <div id="timesModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Adjust Time Settings</h3>
        <button id="btnCloseTimes" class="text-gray-500 hover:text-gray-700">&times;</button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Socket Timeouts -->
        <div class="space-y-3">
          <h4 class="font-medium border-b pb-1">Socket Timeouts</h4>
          <div>
            <label class="block text-sm mb-1">Device Connection (s)</label>
            <input type="number" id="deviceConnectTimeout" class="w-full border rounded p-2" step="0.1" min="1" max="30">
          </div>
          <div>
            <label class="block text-sm mb-1">Device Receive (s)</label>
            <input type="number" id="deviceRecvTimeout" class="w-full border rounded p-2" step="0.1" min="0.5" max="10">
          </div>
          <div>
            <label class="block text-sm mb-1">Client Socket (s)</label>
            <input type="number" id="clientSocketTimeout" class="w-full border rounded p-2" step="0.1" min="0.5" max="10">
          </div>
        </div>

        <!-- Reconnection Delays -->
        <div class="space-y-3">
          <h4 class="font-medium border-b pb-1">Reconnection Delays</h4>
          <div>
            <label class="block text-sm mb-1">Initial Retry Base (s)</label>
            <input type="number" id="reconnectBaseDelay" class="w-full border rounded p-2" step="0.1" min="0.1" max="5">
          </div>
          <div>
            <label class="block text-sm mb-1">Max Backoff (s)</label>
            <input type="number" id="maxBackoff" class="w-full border rounded p-2" step="1" min="10" max="60">
          </div>
          <div>
            <label class="block text-sm mb-1">Check Interval (s)</label>
            <input type="number" id="reconnectCheckInterval" class="w-full border rounded p-2" step="1" min="1" max="60">
          </div>
        </div>

        <!-- Data Streaming -->
        <div class="space-y-3">
          <h4 class="font-medium border-b pb-1">Data Streaming (ms)</h4>
          <div>
            <label class="block text-sm mb-1">Default Char Delay</label>
            <input type="number" id="defaultCharDelay" class="w-full border rounded p-2" step="10" min="10" max="5000">
          </div>
          <div>
            <label class="block text-sm mb-1">S1 Char Delay</label>
            <input type="number" id="s1CharDelay" class="w-full border rounded p-2" step="10" min="10" max="5000">
          </div>
          <div>
            <label class="block text-sm mb-1">S2 Char Delay</label>
            <input type="number" id="s2CharDelay" class="w-full border rounded p-2" step="10" min="10" max="5000">
          </div>
        </div>

        <!-- Command Sequences -->
        <div class="space-y-3">
          <h4 class="font-medium border-b pb-1">Command Sequences</h4>
          <div>
            <label class="block text-sm mb-1">Frame Delay (s)</label>
            <input type="number" id="frameDelay" class="w-full border rounded p-2" step="0.1" >
          </div>
          <div>
            <label class="block text-sm mb-1">Follow-up Delay (s)</label>
            <input type="number" id="followupDelay" class="w-full border rounded p-2" step="1">
          </div>
          <div>
            <label class="block text-sm mb-1">Plc Signal Period  (s)</label>
            <input type="number" id="PlcSignal" class="w-full border rounded p-2" step="0.1" >
          </div>
        </div>

        <!-- Web Interface -->
        <div class="space-y-3">
          <h4 class="font-medium border-b pb-1">Web Interface (ms)</h4>
          <div>
            <label class="block text-sm mb-1">Status Refresh</label>
            <input type="number" id="statusRefresh" class="w-full border rounded p-2" step="100" min="500" max="10000">
          </div>
          <div>
            <label class="block text-sm mb-1">Log Polling</label>
            <input type="number" id="logPolling" class="w-full border rounded p-2" step="100" min="500" max="10000">
          </div>
          <div>
            <label class="block text-sm mb-1">Server4 Refresh</label>
            <input type="number" id="server4Refresh" class="w-full border rounded p-2" step="100" min="500" max="10000">
          </div>
          
          <div>
            <label class="block text-sm mb-1">Image Time Out (s)</label>
            <input type="number" id="ImageTimeout" class="w-full border rounded p-2" step="1" >
        </div>
        </div>

        <!-- API & Database -->
        <div class="space-y-3">
          <h4 class="font-medium border-b pb-1">API & Database</h4>
          <div>
            <label class="block text-sm mb-1">Send Timeout (s)</label>
            <input type="number" id="sendTimeout" class="w-full border rounded p-2" step="1" >
          </div>
          <div>
            <label class="block text-sm mb-1">Auto-send Gap (ms)</label>
            <input type="number" id="autoSendGap" class="w-full border rounded p-2" step="10" >
          </div>
          <div>
            <label class="block text-sm mb-1">DB Timeout (s)</label>
            <input type="number" id="dbTimeout" class="w-full border rounded p-2" step="1" >
          </div>
        </div>
        
        
      </div>

      <div class="flex gap-2 mt-6">
        <button id="btnSaveTimes" class="btn btn-primary flex-1">Save Settings</button>
        <button id="btnResetTimes" class="btn btn-ghost">Reset to Defaults</button>
        <button id="btnCancelTimes" class="btn btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Error Popup Modal -->
  <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 w-full max-w-2xl text-center">
      <div class="text-red-500 mb-6">
        <svg class="w-24 h-24 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <h2 class="text-4xl font-bold text-red-600 mb-4">ERROR</h2>
      <p class="text-xl text-gray-700 dark:text-gray-300 mb-2">Station Two Error Condition Detected</p>
      <p class="text-lg text-gray-600 dark:text-gray-400 mb-8">Please check Station Two and reset when ready</p>
      <button id="btnResetError" class="px-8 py-4 bg-red-600 text-white text-xl font-bold rounded-lg hover:bg-red-700 transition-colors">
        RESET
      </button>
    </div>
  </div>

  <div id="toast" style="display:none"></div>


  <script>
    

    // 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù€ Queue ÙƒÙ…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ©
    document.getElementById('btnDummyStation1').addEventListener('click', async () => {
    const input = document.getElementById('dummyStation1');
    const status = document.getElementById('dummyStation1Status');
    const value = input.value.trim();

    if (!value) return;

    try {
        const response = await fetch('/home/add_to_queue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dummy_number: value })
        });

        if (response.ok) {
            const res = await response.json();
            status.innerText = `âœ… Sent! Queue Size: ${res.current_count}`;
            status.className = "text-xs mt-2 text-emerald-600 font-bold";
            input.value = ""; // ØªØµÙÙŠØ± Ø§Ù„Ø®Ø§Ù†Ø©
        }
    } catch (err) {
        status.innerText = "âŒ Connection Failed";
        status.className = "text-xs mt-2 text-red-500";
    }
});
document.getElementById('btnDummyStation2').addEventListener('click', async () => {
    const input = document.getElementById('dummyStation2');
    const status = document.getElementById('dummyStation2Status');
    const value = input.value.trim();

    if (!value) return;

    try {
        const response = await fetch('/home/add_to_queue2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dummy_number: value })
        });

        if (response.ok) {
            const res = await response.json();
            status.innerText = `âœ… Sent! Queue Size: ${res.current_count}`;
            status.className = "text-xs mt-2 text-emerald-600 font-bold";
            input.value = ""; // ØªØµÙÙŠØ± Ø§Ù„Ø®Ø§Ù†Ø©
        }
    } catch (err) {
        status.innerText = "âŒ Connection Failed";
        status.className = "text-xs mt-2 text-red-500";
    }
});
    window.__currentProgramS1 = { sku: null, part: null, file: null, label: null, data: null };
    window.__currentProgramS2 = { sku: null, part: null, file: null, label: null, data: null };
    let lastSeq = 0, AUTO_SEND_ENABLED = true, lastTriggerAt = 0;
    const sendQueue = []; let queueWorking = false;
    const $ = (id) => document.getElementById(id);

    // Times Adjustment Modal Functionality
    let currentTimeSettings = {};

    // Default time settings
    const DEFAULT_TIME_SETTINGS = {
        deviceConnectTimeout: 5.0,
        deviceRecvTimeout: 1.0,
        clientSocketTimeout: 1.0,
        reconnectBaseDelay: 0.5,
        maxBackoff: 30,
        reconnectCheckInterval: 1,
        defaultCharDelay: 100,
        s1CharDelay: 100,
        s2CharDelay: 100,
        frameDelay: 1,
        followupDelay: 30,
        statusRefresh: 1500,
        logPolling: 800,
        server4Refresh: 2000,
        sendTimeout: 25,
        autoSendGap: 120,
        dbTimeout: 10,
        ImageTimeout :10, 
        PlcSignal : 0.1
    };

    // Load current time settings
    async function loadTimeSettings() {
        try {
            const response = await fetch('/time_settings');
            const data = await response.json();
            if (data.ok) {
                currentTimeSettings = data.settings;
                populateTimeForm(currentTimeSettings);
            } else {
                // Use defaults if no settings found
                currentTimeSettings = {...DEFAULT_TIME_SETTINGS};
                populateTimeForm(currentTimeSettings);
            }
        } catch (error) {
            console.error('Failed to load time settings:', error);
            currentTimeSettings = {...DEFAULT_TIME_SETTINGS};
            populateTimeForm(currentTimeSettings);
        }
    }

    // Populate the form with current settings
    function populateTimeForm(settings) {
        for (const [key, value] of Object.entries(settings)) {
            const element = $(key);
            if (element) {
                element.value = value;
            }
        }
        
        // Also update the UI elements that use these values
        if ($('delayS1')) $('delayS1').value = settings.s1CharDelay;
        if ($('delayS2')) $('delayS2').value = settings.s2CharDelay;
        if ($('delay')) $('delay').value = settings.defaultCharDelay;
    }

    // Collect form data
    function collectTimeSettings() {
        const settings = {};
        for (const key of Object.keys(DEFAULT_TIME_SETTINGS)) {
            const element = $(key);
            if (element) {
                settings[key] = parseFloat(element.value) || DEFAULT_TIME_SETTINGS[key];
            }
        }
        return settings;
    }

    // Save time settings
    async function saveTimeSettings(settings) {
        try {
            const response = await fetch('/time_settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings)
            });
            const data = await response.json();
            if (data.ok) {
                showToast('Time settings saved successfully', 'green');
                currentTimeSettings = {...settings};
                updateUIWithNewTimes();
                return true;
            } else {
                showToast('Failed to save time settings: ' + data.msg, 'red');
                return false;
            }
        } catch (error) {
            showToast('Error saving time settings: ' + error.message, 'red');
            return false;
        }
    }

    // Update UI with new time settings
    function updateUIWithNewTimes() {
        // Update the delay input fields
        if ($('delayS1')) $('delayS1').value = currentTimeSettings.s1CharDelay;
        if ($('delayS2')) $('delayS2').value = currentTimeSettings.s2CharDelay;
        if ($('delay')) $('delay').value = currentTimeSettings.defaultCharDelay;
        
        // Update intervals (would need to restart them)
        if (window.statusInterval) {
            clearInterval(window.statusInterval);
            window.statusInterval = setInterval(refreshStatus, currentTimeSettings.statusRefresh);
        }
        if (window.logInterval) {
            clearInterval(window.logInterval);
            window.logInterval = setInterval(pullLogs, currentTimeSettings.logPolling);
        }
        if (window.server4Interval) {
            clearInterval(window.server4Interval);
            window.server4Interval = setInterval(refreshServer4, currentTimeSettings.server4Refresh);
        }
    }

    // Event Listeners for Times Modal
    $('btnAdjustTimes').addEventListener('click', function() {
        loadTimeSettings();
        $('timesModal').classList.remove('hidden');
    });

    $('btnCloseTimes').addEventListener('click', function() {
        $('timesModal').classList.add('hidden');
    });

    $('btnCancelTimes').addEventListener('click', function() {
        $('timesModal').classList.add('hidden');
    });

    $('btnResetTimes').addEventListener('click', async function() {
    if (confirm('Reset all time settings to defaults?')) {
        populateTimeForm(DEFAULT_TIME_SETTINGS);
        const success = await saveTimeSettings(DEFAULT_TIME_SETTINGS);
        if (success) {
            showToast('Settings reset to defaults successfully', 'green');
        }
    }
   });

    $('btnSaveTimes').addEventListener('click', async function() {
        const newSettings = collectTimeSettings();
        const success = await saveTimeSettings(newSettings);
        if (success) {
            $('timesModal').classList.add('hidden');
        }
    });

    // Close modal when clicking outside
    $('timesModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });

    // Error popup handling
    function showErrorPopup() {
        const modal = $('errorModal');
        if (modal) {
            modal.classList.remove('hidden');
            // Disable auto-send while error is active
            AUTO_SEND_ENABLED = false;
            if ($('autoSwitch')) $('autoSwitch').checked = false;
        }
    }

    function hideErrorPopup() {
        const modal = $('errorModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    async function resetErrorCondition() {
        try {
            const response = await fetch('/reset_error', { 
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const result = await response.json();
            
            if (result.ok) {
                showToast('Error condition reset successfully', 'green');
                hideErrorPopup();
                // Re-enable auto-send after reset
                AUTO_SEND_ENABLED = true;
                if ($('autoSwitch')) $('autoSwitch').checked = true;
            } else {
                showToast('Reset failed: ' + result.msg, 'red');
            }
        } catch (error) {
            showToast('Reset error: ' + error.message, 'red');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const sw = $("autoSwitch"); if (sw) sw.addEventListener("change", ()=>{ AUTO_SEND_ENABLED = $("autoSwitch").checked; });
      
      // Add event listener for reset button
      const resetBtn = $('btnResetError');
      if (resetBtn) {
          resetBtn.addEventListener('click', resetErrorCondition);
      }
    });

    function setSendingUI(on){ 
      $("btnSendS1").disabled = on; 
      $("btnSendS2").disabled = on; 
    }
    function fetchWithTimeout(url, options={}, timeoutMs=10000){
      const controller = new AbortController(); const t = setTimeout(()=>controller.abort(), timeoutMs);
      const opts = Object.assign({}, options, {signal: controller.signal}); return fetch(url, opts).finally(()=>clearTimeout(t));
    }

    function enqueueSend(payload){ sendQueue.push(payload); if(!queueWorking) processQueue(); }
    async function processQueue(){
      if(queueWorking) return; queueWorking = true; setSendingUI(true);
      try{
        while(sendQueue.length){
          const p = sendQueue.shift();
          try{
            const res = await fetchWithTimeout('/send', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(p) }, 25000);
            const j = await res.json(); if(!res.ok || !j.ok){ showToast(j.msg || "Send failed", "red"); } else { showToast('Sent', ''); }
          }catch(e){ showToast("Network error: " + (e.message||e), "red"); }
        }
      } finally { setSendingUI(false); queueWorking = false; }
    }

    function showToast(message, cls){ const t = $("toast"); t.className = "toast " + (cls||""); t.textContent = message; t.style.display = "block"; clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(()=>{t.style.display='none'}, 2200); }

    function hexToBytes(hexStr){ const cleaned = (hexStr||"").replace(/[^0-9a-f]/gi, ""); const out=[]; for(let i=0;i<cleaned.length;i+=2){ const h = cleaned.slice(i,i+2); if(h.length===2) out.push(parseInt(h,16)); } return out; }
    function popupFromHexPayload(hexPayload){ const bytes = hexToBytes(hexPayload); for(const b of bytes){ if(b===0x30){ showToast("Not Good (0x30)","red"); return; } if(b===0x31){ showToast("OK (0x31)","green"); return; } } }
    function asciiFromHex(hexStr){ const cleaned = (hexStr||"").replace(/[^0-9a-f]/gi, ""); let out = ""; for (let i=0;i<cleaned.length;i+=2){ const h = cleaned.slice(i,i+2); if (h.length===2){ const code = parseInt(h,16); out += (code>=0x20 && code<=0x7E) ? String.fromCharCode(code) : " "; } } return out; }

    function detectSkuAndPart(asciiStr){
      if(!asciiStr) return null; const candidates = [];
      let m = asciiStr.match(/([A-Za-z0-9_-]{3,})\s*\.?S([12])(?:\.csv)?\b/i); if (m) candidates.push({ sku: m[1], part: ("S"+m[2]).toUpperCase(), conf: 3 });
      m = asciiStr.match(/\bsku[:\s]*([A-Za-z0-9_-]{3,})\s*(S[12])\b/i); if (m) candidates.push({ sku: m[1], part: m[2].toUpperCase(), conf: 2 });
      const skuTok = (asciiStr.match(/\b[A-Za-z0-9_-]{3,}\b/g) || []).sort((a,b)=>b.length-a.length)[0];
      const partTok = (asciiStr.match(/\bS[12]\b/i) || [null])[0];
      if (skuTok && partTok) candidates.push({ sku: skuTok, part: partTok.toUpperCase(), conf: 1 });
      if (candidates.length) { candidates.sort((a,b)=>b.conf-a.conf); return candidates[0]; }
      if (skuTok) return { sku: skuTok, part: null, conf: 0 }; return null;
    }

    async function fetchJSONWithRetry(url, options={}, tries=3, baseDelay=120){
      let lastErr=null; for(let i=0;i<tries;i++){ try{ const r = await fetchWithTimeout(url, options, 7000 + 1500*i); const j = await r.json(); if(!r.ok) throw new Error(j.msg || "Request failed"); return j; }catch(e){ lastErr = e; await new Promise(res=>setTimeout(res, baseDelay*Math.pow(2,i))); } }
      throw lastErr || new Error("Network error");
    }

    async function loadCodesFor(sku, part){ return await fetchJSONWithRetry('/program_data_file/' + encodeURIComponent(sku) + '/' + encodeURIComponent(part), {method:'GET'}); }
    function valueToCode(v){ if(!v) return ''; const ix = v.indexOf('|'); return ix >= 0 ? v.slice(ix+1).trim() : ''; }
    function buildCodesForPart(data, part){
    if(part === "S1"){
        // Start with predefined S1 fields
        const order = ["Front Logo", "Display logo", "Color", "Data logo", "Inverter logo", "Power logo"];
        // Add any additional fields that aren't in the predefined list
        const additionalFields = Object.keys(data).filter(k => !order.includes(k) && !["Label", "Value", "Model Name"].includes(k));
        // Combine predefined and additional fields
        const allFields = order.concat(additionalFields.sort());
        return allFields.map(k => valueToCode(data[k]||"")).join('');
    } else {
        // Start with predefined S2 fields
        const order = ["Eva cover", "Drawer printing", "Color logo", "Fan cover", "Shelve color"];
        // Add any additional fields that aren't in the predefined list
        const additionalFields = Object.keys(data).filter(k => !order.includes(k) && !["Label", "Value", "Model Name"].includes(k));
        // Combine predefined and additional fields
        const allFields = order.concat(additionalFields.sort());
        return allFields.map(k => valueToCode(data[k]||"")).join('');
    }
}

    async function tryFillMessageFromDeviceHex_exact(hexPayload){
      const asciiStr = asciiFromHex(hexPayload); const info = detectSkuAndPart(asciiStr); if (!info) return;
      let sku = (info.sku||"").trim(); let part = info.part ? info.part.toUpperCase() : null;
      try{
        if (part){
          const j = await loadCodesFor(sku, part);
          if (j && j.ok){ 
            let messageBox, currentProgram, autoSendFunc;
            
            if (part === "S1") {
              messageBox = $("messageS1");
              currentProgram = window.__currentProgramS1;
              autoSendFunc = autoSendAfterFillS1;
              window.__currentProgramS1 = { sku: j.sku, part: j.part, file: null, label: j.sku + j.part + '.csv', data: j.data };
            } else {
              messageBox = $("messageS2");
              currentProgram = window.__currentProgramS2;
              autoSendFunc = autoSendAfterFillS2;
              window.__currentProgramS2 = { sku: j.sku, part: j.part, file: null, label: j.sku + j.part + '.csv', data: j.data };
            }
            
            messageBox.value = j.codes || ""; 
            showToast(`Loaded ${j.sku}${j.part} â†’ Message filled`, ""); 
            if (AUTO_SEND_ENABLED) autoSendFunc(); 
            return; 
          }
        } else {
          const probe = await fetchJSONWithRetry('/program_probe/' + encodeURIComponent(sku), {method:'GET'});
        if (probe && probe.ok){
            if (probe.exists.S1){ const j1 = await loadCodesFor(sku, "S1"); if (j1 && j1.ok){ 
              $("messageS1").value = j1.codes || ""; 
              window.__currentProgramS1 = { sku: j1.sku, part: "S1", file: null, label: j1.sku + 'S1.csv', data: j1.data }; 
              showToast(`Loaded ${j1.sku}S1 â†’ Message filled`, ""); 
              if (AUTO_SEND_ENABLED) autoSendAfterFillS1(); 
              return; 
            } }
            if (probe.exists.S2){ const j2 = await loadCodesFor(sku, "S2"); if (j2 && j2.ok){ 
              $("messageS2").value = j2.codes || ""; 
              window.__currentProgramS2 = { sku: j2.sku, part: "S2", file: null, label: j2.sku + 'S2.csv', data: j2.data }; 
              showToast(`Loaded ${j2.sku}S2 â†’ Message filled`, ""); 
              if (AUTO_SEND_ENABLED) autoSendAfterFillS2(); 
              return; 
            } }
            showToast(`No CSV found for ${sku} (S1/S2)`, "red");
          }
        }
      }catch(e){ showToast(e.message || "Load failed", "red"); }
    }

    // NEW: Handle ProductNumber-based auto-loading from logs
    function handleProductNumberAutoLoad(line) {
      if (line.includes("PRODUCT_NUMBER_CSV_LOADED:")) {
        const match = line.match(/PRODUCT_NUMBER_CSV_LOADED: (\S+) (\S+)/);
        if (match) {
          const filename = match[1];
          const codes = match[2];
          
          // Only update S1 message box (not S2)
          const messageBoxS1 = $("messageS1");
          if (messageBoxS1) {
            messageBoxS1.value = codes;
            showToast(`Auto-loaded from ProductNumber: ${filename}`, "green");
            
            // Update current program for S1
            window.__currentProgramS1 = { 
              sku: filename.replace('S1.csv', ''), 
              part: "S1", 
              file: filename, 
              label: filename, 
              data: {} 
            };
            
            // Auto-send if enabled
            if (AUTO_SEND_ENABLED) {
              autoSendAfterFillS1();
            }
          }
        }
      }
    }

    // NEW: Handle S2 ProductNumber-based auto-loading from logs
    function handleProductNumberAutoLoadS2(line) {
      if (line.includes("PRODUCT_NUMBER_CSV_LOADED_S2:")) {
        const match = line.match(/PRODUCT_NUMBER_CSV_LOADED_S2: (\S+) (\S+)/);
        if (match) {
          const filename = match[1];
          const codes = match[2];
          
          // Update S2 message box (not S1)
          const messageBoxS2 = $("messageS2");
          if (messageBoxS2) {
            messageBoxS2.value = codes;
            showToast(`Server2 Auto-loaded from ProductNumber: ${filename}`, "green");
            
            // Update current program for S2
            window.__currentProgramS2 = { 
              sku: filename.replace('S2.csv', ''), 
              part: "S2", 
              file: filename, 
              label: filename, 
              data: {} 
            };
            
            // Auto-send if enabled
            if (AUTO_SEND_ENABLED) {
              autoSendAfterFillS2();
            }
          }
        }
      }
    }

    // NEW: Handle ERROR_POPUP messages
    function handleErrorPopup(line) {
      if (line.includes("ERROR_POPUP")) {
        showErrorPopup();
      }
    }

    async function api(path, method="GET", body=null){
      const opt = {method, headers: {"Content-Type":"application/json"}}; if(body) opt.body = JSON.stringify(body);
      const r = await fetchWithTimeout(path, opt, 8000); const j = await r.json(); if(!r.ok) throw new Error(j.msg || "Request failed"); return j;
    }

    async function clearLogs(){ try{ await api("/logs/clear","POST"); lastSeq=0; $("logBox").textContent=""; } catch(e){ showToast(e.message,"red"); } }

    async function refreshStatus(){
      try{
        const j = await api("/status");
        const clientSelect = $("clientSelect"), clientList = $("clientList"), deviceStatus = $("deviceStatus");
        clientSelect.innerHTML = ''; clientList.innerHTML = '';
        
        // Server is always running now, so status is always "Running"
        deviceStatus.textContent = `Device (${j.device_addr||'-'}): ${j.device_connected ? 'Connected' : 'Not Connected'}`;
        deviceStatus.className = `text-sm ${j.device_connected ? 'text-green-400' : 'text-red-400'}`;

        const optPlaceholder = document.createElement('option'); 
        optPlaceholder.value = '';
        optPlaceholder.textContent = j.clients && j.clients.length ? 'Select clientâ€¦' : 'No clients'; 
        clientSelect.appendChild(optPlaceholder);
        
        (j.clients || []).forEach(cid => {
          const li = document.createElement('li'); 
          li.textContent = cid;
          li.className = 'px-3 py-2 rounded-lg border border-slate-300/50'; 
          clientList.appendChild(li);
          
          const opt = document.createElement('option'); 
          opt.value = cid; 
          opt.textContent = cid; 
          clientSelect.appendChild(opt);
        });
      }catch(e){ 
        // If status check fails, server is still considered running
        console.log("Status check failed:", e);
      }
    }

    function extractHexPayload(line){
      const idx = line.lastIndexOf(':');
      if(idx !== -1 && idx+1 < line.length){
        const tail = line.slice(idx+1).trim();
        if (/^[0-9a-fA-F\s]+$/.test(tail) && tail.replace(/\s+/g,'').length >= 4) return tail;
      }
      const matches = line.match(/[0-9a-fA-F]{8,}(?:\s+[0-9a-fA-F]{2,})*/g);
      if(matches && matches.length){
        matches.sort((a,b)=>b.replace(/\s+/g,'').length - a.replace(/\s+/g,'').length);
        return matches[0];
      }
      return null;
    }

    function pushLog(line, level){
      const filter = $("logFilter").value; if(filter !== "ALL" && filter !== level) return;
      const box = $("logBox"); const div = document.createElement('div'); div.textContent = line; box.appendChild(div);
      while(box.children.length > 500){ box.removeChild(box.firstChild); } box.scrollTop = box.scrollHeight;
      
      // Check for ERROR_POPUP messages
      if (level === "ERROR_POPUP") {
          showErrorPopup();
      }
      
      // Check for ProductNumber-based auto-load messages for both S1 and S2
      if (level === "AUTO_LOAD") {
        handleProductNumberAutoLoad(line);  // For S1
        handleProductNumberAutoLoadS2(line); // For S2
      }
      
      const hexPayload = extractHexPayload(line); if(!hexPayload) return;
      if(level === "RX"){ popupFromHexPayload(hexPayload); tryFillMessageFromDeviceHex_exact(hexPayload); }
      if(level === "DEV_RX"){ tryFillMessageFromDeviceHex_exact(hexPayload); }
    }

    async function pullLogs(){ try{ const j = await api('/logs?since=' + lastSeq, 'GET'); lastSeq = j.last || lastSeq; j.logs.forEach(row => { const line = `[${row.time}] ${row.level.padEnd(8)} | ${row.msg}`; pushLog(line, row.level); }); }catch(e){ } }

    // Build payload for S1
    function buildPayloadS1() {
        const message = $("messageS1").value;
        const encoding = $("hexModeS1").checked ? 'hex' : 'utf-8';
        const char_delay_ms = parseInt($("delayS1").value, 10) || currentTimeSettings.s1CharDelay || 100;
        const program_part = "S1";
        const program_label = (window.__currentProgramS1 && window.__currentProgramS1.label) ? window.__currentProgramS1.label : "Manual Input S1";
        const program_data = (window.__currentProgramS1 && window.__currentProgramS1.data) ? window.__currentProgramS1.data : {};
        return {message, encoding, target: 'combined', char_delay_ms, retries: 1, program_part, program_label, program_data};
    }

    // Build payload for S2
    function buildPayloadS2() {
        const message = $("messageS2").value;
        const encoding = $("hexModeS2").checked ? 'hex' : 'utf-8';
        const char_delay_ms = parseInt($("delayS2").value, 10) || currentTimeSettings.s2CharDelay || 100;
        const program_part = "S2";
        const program_label = (window.__currentProgramS2 && window.__currentProgramS2.label) ? window.__currentProgramS2.label : "Manual Input S2";
        const program_data = (window.__currentProgramS2 && window.__currentProgramS2.data) ? window.__currentProgramS2.data : {};
        return {message, encoding, target: 'combined', char_delay_ms, retries: 1, program_part, program_label, program_data};
    }

    // New send functions for S1 and S2
    function manualSendS1() { 
        enqueueSend(buildPayloadS1()); 
    }

    function manualSendS2() { 
        enqueueSend(buildPayloadS2()); 
    }

    // Update auto-send functions
    function autoSendAfterFillS1() {
        if(!AUTO_SEND_ENABLED) return;
        const now = Date.now(), MIN_GAP_MS = currentTimeSettings.autoSendGap || 120;
        if(now - lastTriggerAt < MIN_GAP_MS) return;
        lastTriggerAt = now;
        enqueueSend(buildPayloadS1());
    }

    function autoSendAfterFillS2() {
        if(!AUTO_SEND_ENABLED) return;
        const now = Date.now(), MIN_GAP_MS = currentTimeSettings.autoSendGap || 120;
        if(now - lastTriggerAt < MIN_GAP_MS) return;
        lastTriggerAt = now;
        enqueueSend(buildPayloadS2());
    }

    async function copyLogs(){ try{ const box = $("logBox"); const text = Array.from(box.childNodes).map(n=>n.textContent).join('\n'); await navigator.clipboard.writeText(text); showToast("Logs copied",""); }catch(e){ showToast("Copy failed","red"); } }
    async function copyClients(){ try{ const ul = $("clientList"); const text = Array.from(ul.childNodes).map(n=>n.textContent).join('\n'); await navigator.clipboard.writeText(text); showToast("Clients copied",""); }catch(e){ showToast("Copy failed","red"); } }

    async function showProgramData(filename){
      try{
        const j = await api('/program_data/' + encodeURIComponent(filename));
        const d = j.data || {};
        let part = null;
        let messageBox = null;
        let autoSendFunc = null;
        
        if (/S1\.csv$/i.test(filename)) {
            part = "S1";
            messageBox = $("messageS1");
            autoSendFunc = autoSendAfterFillS1;
            window.__currentProgramS1 = { sku: null, part, file: filename, label: filename, data: d };
        } else if (/S2\.csv$/i.test(filename)) {
            part = "S2";
            messageBox = $("messageS2");
            autoSendFunc = autoSendAfterFillS2;
            window.__currentProgramS2 = { sku: null, part, file: filename, label: filename, data: d };
        }
        
        if (part) {
            const codes = buildCodesForPart(d, part);
            messageBox.value = codes;
            showToast(`Program ${filename} loaded â†’ message filled`,"");
            if (AUTO_SEND_ENABLED) autoSendFunc();
        }
      }catch(e){ showToast("Load program failed","red"); }
    }

    // Function to handle auto-detection notifications
    function showAutoDetectionNotification(filename, codes, part) {
      showToast(`Auto-detected program: ${filename}`, "green");
      
      let messageBox, currentProgram, autoSendFunc;
      
      if (part === "S1") {
        messageBox = $("messageS1");
        currentProgram = window.__currentProgramS1;
        autoSendFunc = autoSendAfterFillS1;
        window.__currentProgramS1 = { 
          sku: filename.replace('.csv', ''), 
          part: 'S1', 
          file: filename, 
          label: filename, 
          data: {} 
        };
      } else {
        messageBox = $("messageS2");
        currentProgram = window.__currentProgramS2;
        autoSendFunc = autoSendAfterFillS2;
        window.__currentProgramS2 = { 
          sku: filename.replace('.csv', ''), 
          part: 'S2', 
          file: filename, 
          label: filename, 
          data: {}  
        };
      }
      
      // Update the message box with the codes
      messageBox.value = codes;
      
      // Auto-send if enabled
      if (AUTO_SEND_ENABLED) {
        autoSendFunc();
      }
    }

    // Function to update last received data
    async function updateLastReceivedData() {
      try {
        const response = await fetch('/last_received_data');
        const data = await response.json();
        
        // Update dummy number
        const dummyElement = document.getElementById('dummyNumber');
        if (dummyElement) {
          dummyElement.textContent = data.dummy_number || '-';
        }
        
        // Update last received data
        const receivedElement = document.getElementById('lastReceivedData');
        if (receivedElement) {
          receivedElement.textContent = data.received_data || 'No data';
          receivedElement.title = data.received_data || ''; // Show full text on hover
        }
      } catch (error) {
        console.log('Failed to fetch last received data:', error);
      }
    }

    // Function to check ProductNumber status
    async function checkProductNumberStatus() {
      try {
        const response = await fetch('/current_product_status');
        const data = await response.json();
        
        // Update ProductNumber display if available
        if (data.product_number_s1 && data.product_number_s1 !== window.lastProductNumberS1) {
          window.lastProductNumberS1 = data.product_number_s1;
          // The backend will automatically load the CSV, but we can update UI
          showToast(`ProductNumber detected: ${data.product_number_s1}`, "blue");
        }
      } catch (error) {
        // Silent fail - this is just for UI updates
      }
    }

    // Add auto-detect button event listener
    $("btnAutoDetect").addEventListener('click', async function() {
      try {
        const response = await fetch('/auto_detect_csv', { method: 'POST' });
        const result = await response.json();
        
        if (result.ok && result.matched) {
          showAutoDetectionNotification(result.filename, result.codes, result.part);
        } else if (result.ok) {
          showToast("No matching CSV found", "red");
        } else {
          showToast(result.msg || "Detection failed", "red");
        }
      } catch (error) {
        showToast("Auto-detection failed", "red");
      }
    });

    // Add dummy-triggered auto-detect button event listener
    $("btnAutoDetectDummy").addEventListener('click', async function() {
      try {
        const response = await fetch('/auto_detect_csv_dummy', { method: 'POST' });
        const result = await response.json();
        
        if (result.ok && result.matched) {
          showAutoDetectionNotification(result.filename, result.codes, result.part);
        } else if (result.ok) {
          showToast("No matching CSV found for current dummy number", "red");
        } else {
          showToast(result.msg || "Dummy detection failed", "red");
        }
      } catch (error) {
        showToast("Dummy-triggered auto-detection failed", "red");
      }
    });

    // Add event listener for Server4 auto-detect button
    $("btnAutoDetectS4").addEventListener('click', async function() {
      try {
        const response = await fetch('/auto_detect_csv', { method: 'POST' });
        const result = await response.json();
        
        if (result.ok && result.matched) {
          showAutoDetectionNotification(result.filename, result.codes, result.part);
        } else if (result.ok) {
          showToast("No matching CSV found", "red");
        } else {
          showToast(result.msg || "Detection failed", "red");
        }
      } catch (error) {
        showToast("Auto-detection failed", "red");
      }
    });

    // Add event listener for Server4 dummy-triggered auto-detect button
    $("btnAutoDetectS4Dummy").addEventListener('click', async function() {
      try {
        const response = await fetch('/auto_detect_csv_dummy', { method: 'POST' });
        const result = await response.json();
        
        if (result.ok && result.matched) {
          showAutoDetectionNotification(result.filename, result.codes, result.part);
        } else if (result.ok) {
          showToast("No matching CSV found for current dummy number", "red");
        } else {
          showToast(result.msg || "Dummy detection failed", "red");
        }
      } catch (error) {
        showToast("Dummy-triggered auto-detection failed", "red");
      }
    });

    $("btnClearLogs").addEventListener('click', clearLogs);
    $("btnSendS1").addEventListener('click', manualSendS1);
    $("btnSendS2").addEventListener('click', manualSendS2);
    $("btnCopyLogs").addEventListener('click', copyLogs);
    $("btnCopyClients").addEventListener('click', copyClients);
    $("logFilter").addEventListener('change', ()=>{ $("logBox").textContent=""; lastSeq=0; });

    // Update interval setup to use configurable times
    function setupIntervals() {
        // Clear existing intervals
        if (window.statusInterval) clearInterval(window.statusInterval);
        if (window.logInterval) clearInterval(window.logInterval);
        if (window.server4Interval) clearInterval(window.server4Interval);
        if (window.dataInterval) clearInterval(window.dataInterval);
        if (window.productNumberInterval) clearInterval(window.productNumberInterval);
        
        // Set up new intervals with current settings
        window.statusInterval = setInterval(refreshStatus, currentTimeSettings.statusRefresh || 1500);
        window.logInterval = setInterval(pullLogs, currentTimeSettings.logPolling || 800);
        window.server4Interval = setInterval(refreshServer4, currentTimeSettings.server4Refresh || 2000);
        window.dataInterval = setInterval(updateLastReceivedData, 1000);
        window.productNumberInterval = setInterval(checkProductNumberStatus, 2000);
    }

    // Initialize intervals after loading settings
    loadTimeSettings().then(() => {
        setupIntervals();
    });

// --- Server4 dedicated panel ---
async function refreshServer4(){
  try{
    const r = await fetchWithTimeout('/server4_status', {}, 6000);
    const j = await r.json();
    if(!j.ok) throw new Error(j.msg || 'Server4 status failed');
    const s = j.server4 || {};
    $('s4Conn').textContent = s.device_connected ? 'Connected' : 'Not Connected';
    $('s4Conn').className = s.device_connected ? 'mt-1 font-medium text-green-500' : 'mt-1 font-medium text-red-400';
    $('s4Addr').textContent = s.device_addr || '-';
    $('s4Clients').textContent = String(s.client_count || 0);
    $('s4LastHex').textContent = s.last_device_hex ? s.last_device_hex.slice(0, 1200) : 'No data';
    $('s4LastTs').textContent = s.last_device_rx_iso || '-';
    const _dummyS4 = document.getElementById('dummyNumberS4');
    if (_dummyS4) { _dummyS4.textContent = (j.dummy_number || '-'); }
  }catch(e){
    console.log('Server4 refresh error:', e);
  }
}
 
  </script>
</body>
</html>
